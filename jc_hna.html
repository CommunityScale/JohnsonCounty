<html lang="en">
    <head>
        <meta charset="utf-8" />
        <title>Johnson County draft</title>
        <meta name="viewport" content="width=device-width, initial-scale=1" />

<link
  href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css"
  rel="stylesheet">

<link 
    href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" 
    rel="stylesheet">

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script> 
    <script src="https://unpkg.com/@turf/turf@^7/turf.min.js"></script> 

    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }

        #map {
            width: 100%;
            flex-shrink: 1;
            height: 100%;
        }

       .mapboxgl-popup {
            width: 175px;
            font: 12px/20px 'Roboto', sans-serif;
            background-color: #425A70;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            display: block;
            padding: 0;
            margin: 0;
        }

        .mapboxgl-popup .mapboxgl-popup-tip {
            display: none;
        }

        .mapboxgl-popup-close-button {
            top: 2px; 
            right: 4px; 
            width: 7px;
            height: 7px;
            color: #fff; 
        }

        .mapboxgl-popup-header {
            margin: 0px;
            font-size: 16px;
            color: #fff;
            font-weight: bold;
            padding: 5px;
        }
    
        .mapboxgl-popup-content {
            font-size: 12px;
            color: #425A70;
            margin-left: 0px;
            padding: 8px;
            background-color: #fff;
            line-height: 1.25;
        }

        #container  {
           display: flex;
           height: 100%;
           width: 100%;
           position: relative;
        }

        #layer-dropdown {
            width: auto;
            font-size: 16px;
            padding: 8px;
            margin: 10px 0;
            z-index: 10;
            background-color: #f2f0ef;
            position: absolute;
            top: 25px;
            left: 30px;
            font: 'Roboto', sans-serif;
            font-size: 14px;
            display: flex;
            flex-shrink: 1;
            border-radius: 2;
            opacity: 0.95;
            border: #80808090;
        }

        #layer-controls {
            position: absolute;
            top: 25px;
            right: 30px;
            background: white;
            padding: 10px;
            font: 14px 'Roboto', sans-serif;
            z-index: 2;
            border-radius: 4px;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
        }

        .legend {
            background-color: #fff;
            border-radius: 4px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            font: 14px/24px 'Roboto', sans-serif;
            padding: 10px;
            position: absolute;
            right: 30px;
            bottom: 50px;
            width: 180px;
            flex-shrink: 1;
            text-wrap: balance;
            z-index: 11;
            line-height: 18px;
        }
 
        .legend h4 {
            margin: 0 0 10px;
            font: 'Roboto', sans-serif;
        }
 
        .legend div span {
            display: inline-block;
            height: 20px;
            margin-right: 5px;
            width: 20px;
            background-color: white;
            vertical-align: middle;
            padding-bottom: 0;
            text-wrap: nowrap;
        }

    </style>
</head>
<body>
    <div id="container">
        <select id="layer-dropdown">
            <option value="tracts-medIncome">Median Annual Household Income</option> 
            <option value="tracts-pctCostBurdenedRenters">Percent of Renters, Cost Burdened</option> 
            <option value="tracts-pctCostBurdenedOwners">Percent of Homeowners, Cost Burdened</option>
            <option value="parcels-landuse">Property Class</option> 
            <option value="parcels-ownership">Property Tax Credits</option>
            <option value="parcels-pctLV">Land Value as Percent of Assessed Value</option>
            <option value="parcels-value">Parcel Value Per Acre</option>
            <option value="tracts-layer">Johnson County</option>
        </select>
        <div id="opacity-control" style="position: absolute; top: 75px; left: 30px; z-index: 10; background: #f2f0ef; padding: 8px; border-radius: 4px; font-family: Roboto, sans-serif; font-size: 14px;">
            <label for="opacitySlider">Layer Opacity:</label>
            <input type="range" id="opacitySlider" min="0" max="1" step="0.05" value="0.6">
        </div>
        <div id="basemap-toggle" style="position: absolute; top: 120px; left: 30px; z-index: 10; background: #f2f0ef; padding: 8px; border-radius: 4px; font-family: Roboto, sans-serif; font-size: 14px;">
          <label for="basemapStyle">Basemap:</label>
          <select id="basemapStyle">
              <option value="gray">Gray</option>
              <option value="satellite">Satellite</option>
          </select>
      </div>
      <div id="layer-controls">
        <label><input type="checkbox" class="layer-toggle" value="excludedCities-layer" checked>Excluded cities</label>
        </div>
        <div id="medIncomeLegend" class="legend" style="display: block;">
            <h4>Median Annual Household Income (2023, USD)</h4>
            <div><span style="background-color: #980043"></span>$130,000 or more</div>
            <div><span style="background-color: #dd1c77"></span></div>
            <div><span style="background-color: #df65b0"></span></div>
            <div><span style="background-color: #d7b5d8"></span></div>
            <div><span style="background-color: #f1eef6"></span>$15,000 or less</div>
            <div><span style="background-color: #425A7030"></span>No data</div>
        </div>
        <div id="landUseLegend" class="legend" style="display: none;"> 
            <h4>Land Use</h4>
            <div><span style="background-color: #24910a"></span>Agriculture</div>
            <div><span style="background-color: #d4f088"></span>Agricultural/residential</div>
            <div><span style="background-color: #fff8bf"></span>Residential</div>
            <div><span style="background-color: #ffa734"></span>Multifamily</div>
            <div><span style="background-color: #da6262"></span>Commercial</div>
            <div><span style="background-color: #b560bb"></span>Mixed use</div>
            <div><span style="background-color: #323052"></span>Industrial</div>
            <div><span style="background-color: #425A70"></span>Exempt</div>
            <div><span style="background-color: #bdc9e1"></span>Unknown</div>
        </div>
        <div id="cbRentersLegend" class="legend" style="display: none;">
            <h4>Cost Burdened Renters (2023)</h4>
            <div><span style="background-color: #016c59"></span>75%+</div>
            <div><span style="background-color: #1c9099"></span></div>
            <div><span style="background-color: #67a9cf"></span>50%</div>
            <div><span style="background-color: #bdc9e1"></span></div>
            <div><span style="background-color: #f6eff7"></span>0%</div>
            <div><span style="background-color: #425A7030"></span>No data</div>
        </div>
        <div id="cbOwnersLegend" class="legend" style="display: none;">
            <h4>Cost Burdened Homeowners (2023)</h4>
            <div><span style="background-color: #810f7c"></span>35%+</div>
            <div><span style="background-color: #8856a7"></span></div>
            <div><span style="background-color: #8c96c6"></span>15%</div>
            <div><span style="background-color: #b3cde3"></span></div>
            <div><span style="background-color: #edf8fb"></span>0%</div>
            <div><span style="background-color: #425A7030"></span>No data</div>
        </div>
        <div id="pctHHLegend" class="legend" style="display: none;">
            <h4>Percent Change in Households (2013-2023)</h4>
            <div><span style="background-color: #1b7837"></span>50%+</div>
            <div><span style="background-color: #7fbf7b"></span></div>
            <div><span style="background-color: #d9f0d3"></span></div>
            <div><span style="background-color: #f7f7f7"></span>0%</div>
            <div><span style="background-color: #e7d4e8"></span></div>
            <div><span style="background-color: #af8dc3"></span></div>
            <div><span style="background-color: #762a83"></span>-15%+</div>
            <div><span style="background-color: #425A7030"></span>No data</div>
        </div>
        <div id="ncLegend" class="legend" style="display: none">
            <h4>Neighborhood Conditions Index</h4>
            <div><img src="https://raw.githubusercontent.com/CommunityScale/Muskogee/main/images/neighborhoodConditionsLegend.png" 
                alt="Legend for Neighborhood Conditions Index"
                style="max-width: 100%; height: auto; display: block;" ></div>
        </div>
        <div id="pctLVLegend" class="legend" style="display: none;">
            <h4>Land Value as Percent of Assessed Value</h4>
            <div><span style="background-color: #045a8d"></span>3% or less</div>
            <div><span style="background-color: #2b8cbe"></span></div>
            <div><span style="background-color: #74a9cf"></span>35%</div>
            <div><span style="background-color: #bdc9e1"></span></div>
            <div><span style="background-color: #f1eef6"></span>90% or more</div>
        </div>
        <div id="parcelValueLegend" class="legend" style="display: none;">
            <h4>Assessed Value Per Acre</h4>
            <div><span style="background-color: #f2f0f7"></span>$24,000 or less</div>
            <div><span style="background-color: #cbc9e2"></span></div>
            <div><span style="background-color: #9e9ac8"></span>$327,000</div>
            <div><span style="background-color: #756bb1"></span></div>
            <div><span style="background-color: #54278f"></span>$850,000 or more</div>
        </div>
        <div id="ownershipLegend" class="legend" style="display: none;">
            <h4>Tax Credits by Parcel</h4> 
            <div><span style="background-color: #f2e22c"></span>Homestead Deduction (HMST)</div>
            <div><span style="background-color: #fa2173"></span>Military (MIL)</div>
            <div><span style="background-color: #559428"></span>Agricultural Land (AG)</div>
            <div><span style="background-color: #79a8f2"></span>Section 42(h)</div>
            <div><span style="background-color: #e4ac28"></span>HMST, MIL</div>
            <div><span style="background-color: #a7d96d"></span>HMST, AG</div>
            <div><span style="background-color: #8b63ba"></span>HMST, MIL, AG</div>
            <div><span style="background-color: #425A7030"></span>None</div>
        </div>

    <div id="map"></div>
</div>

<script>
    const INITIAL_LOC = [-91.58, 41.67] 
    const INITIAL_ZOOM = 9.5 //set initial zoom (zoom levels 9-12 best for cities depending on size)(this is set to 13 to accomodate the tileset that will need to be uploaded via CLI)
    const communityScaleGray = "#425A70" //could replace with different accent color, I personally like this branding 
    const placeOfInterest = "Johnson County"
    const citiesOfInterest = [
                "Hills",
                "Lone Tree",
                "Oxford",
                "Shueyville",
                "Solon",
                "Swisher"
            ]
    const excludedCities = [
                "Iowa City",
                "Coralville",
                "North Liberty",
                "Tiffin",
                "University Heights"
            ]
    const medIncomePalette = [ //Sequential colorBrewer Purple/Red ramp
                '#f1eef6',
                '#d7b5d8',
                '#df65b0',
                '#dd1c77',
                '#980043'
            ]
    const cbRentersPalette = [ //Sequential colorBrewer GrnBlu ramp
                '#f6eff7',
                '#bdc9e1',
                '#67a9cf',
                '#1c9099',
                '#016c59'
            ]
    const cbOwnersPalette = [ //Sequential colorBrewer BluPur ramp
                '#edf8fb',
                '#b3cde3',
                '#8c96c6',
                '#8856a7',
                '#810f7c'
            ]
    const hhChangePalette = [ //Diverging colorBrewer PurGre ramp
                '#762a83',
                '#af8dc3',
                '#e7d4e8',
                '#f7f7f7',
                '#d9f0d3',
                '#7fbf7b',
                '#1b7837'
            ]

    const landValuePalette = [ //Sequential colorBrewer Blu ramp
                '#f1eef6',
                '#bdc9e1',
                '#74a9cf',
                '#2b8cbe',
                '#045a8d'
            ]
    const parcelValuePalette = [ //colorBrewer purples 
                '#f2f0f7',
                '#cbc9e2',
                '#9e9ac8',
                '#756bb1',
                '#54278f'
            ]

    const ownershipPalette = [ //categorical palette for tax credits -- update!!
                '#f2e22c',
                '#fa2a73',
                '#559428',
                '#79a8f2',
                '#e4ac28',
                '#a7d96d',
                '#8b63ba',
                '#425A70'
            ]
    const landUsePalette = [
                "#24910a", //Agriculture
                "#d4f088", //Agricultural/residential
                "#fff8bf", //Residential
                "#ffa734", //Multifamily
                "#da6262", //Commercial
                "#b560bb", //Mixed use
                "#323052", //Industrial
                "#425A70", //Exempt
                "#bdc9e1" //Unknown
            ]

    mapboxgl.accessToken = 'pk.eyJ1IjoiZW10em90MDEiLCJhIjoiY20zZ2kyd3RpMDRnajJscHoyMG5neGJldyJ9.poXi4pgd2CoXKV2B4kg1Cw ';
    let map;
    const BASEMAP_STYLES = {
      gray: 'mapbox://styles/emtzot01/cm6a8mjb5004g01qrd7cv07mq',
      satellite: 'mapbox://styles/mapbox/satellite-streets-v12'
    };

    function initializeMap(styleKey = 'gray') {
      map = new mapboxgl.Map({
        container: 'map',
        style: BASEMAP_STYLES[styleKey],
        center: INITIAL_LOC,
        zoom: INITIAL_ZOOM
      });


    function adjustMapSize() {
        const sidebarWidth = document.getElementById('sidebar').width;
        const mapContainer = document.getElementById('map');
  
        mapContainer.style.marginLeft = `${sidebarWidth}px`;
        map.resize(); 
        }



    map.on("load", () => {      
        map.addSource("tracts", {    
            type: "geojson",
            data: "https://raw.githubusercontent.com/CommunityScale/JohnsonCounty/main/iaBgs_selectCounties.geojson",
            promoteId: "GEOID"
        })
   
        map.addSource("cities", {    
            type: "geojson",
            data: "https://raw.githubusercontent.com/CommunityScale/JohnsonCounty/main/jc_politicalBoundaries.geojson",
            promoteId: "OBJECTID"
        })

        map.addSource("counties", {    
            type: "geojson",
            data: "https://raw.githubusercontent.com/CommunityScale/JohnsonCounty/main/iaCounties.geojson",
            promoteId: "GEOID"
        })

        map.addSource("parcels", {
            type: "geojson",
            data: 'https://raw.githubusercontent.com/CommunityScale/JohnsonCounty/main/uninc_parcels_jcia.geojson',
            //url: "mapbox://emtzot01.06wm5jay",
            promoteId: "PPN"
        })

        map.addSource("mobileHomeParks", {
            type: "geojson",
            data: "https://raw.githubusercontent.com/CommunityScale/JohnsonCounty/refs/heads/main/mobileHomes_jcia.geojson",
            promoteId: "NAME"
        })

        map.addLayer({
                id: "tracts-layer",  
                type: "fill",
                source: "tracts",
                paint: {
                    'fill-color': communityScaleGray,
                    "fill-opacity": 0.6,
                    "fill-outline-color": "white",
                    "fill-outline-width": 1,
                    "fill-opacity": [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        0.95,
                        0.6
                ]},
                layout: {
                    visibility: "none"
                }
            },"road-label", 
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label"
        )

        map.addLayer({
            id: "tracts-medIncome",  
            type: "fill",
            source: "tracts",
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "medIncome"], null], communityScaleGray,
                    ["interpolate", 
                    ["linear"],
                    ["get", "medIncome"],
                    15000,
                    medIncomePalette[0], 
                    56000,
                    medIncomePalette[1],
                    73000,
                    medIncomePalette[2],
                    95000,
                    medIncomePalette[3],
                    130000,
                    medIncomePalette[4]]],
                "fill-outline-color": "white",
                "fill-opacity": [
                    "case", ["==", ["get", "medIncome"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "visible"
             }
        },
        "settlement-major-label", 
        "settlement-subdivision-label", 
        "settlement-minor-label"
    ) 


    map.addLayer({      
            id: "tracts-pctCostBurdenedRenters",  
            type: "fill",
            source: "tracts",
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "pctRent30"], null], communityScaleGray,
                    ["interpolate", 
                    ["linear"],
                    ["get", "pctRent30"],
                    0,
                    cbRentersPalette[0], 
                    0.25,
                    cbRentersPalette[1],
                    0.50,
                    cbRentersPalette[2],
                    0.60,
                    cbRentersPalette[3],
                    0.75,
                    cbRentersPalette[4]]],
                "fill-outline-color": "white",
                "fill-opacity": [
                    "case", ["==", ["get", "pctRent30"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
             }
        },
        "settlement-major-label", 
        "settlement-subdivision-label", 
        "settlement-minor-label"
    )
    

    map.addLayer({      
            id: "tracts-pctCostBurdenedOwners",  
            type: "fill",
            source: "tracts",
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "pctOwned30"], null], communityScaleGray,
                    ["interpolate",
                    ["linear"],
                    ["get", "pctOwned30"],
                    0,
                    cbOwnersPalette[0],
                    0.11,
                    cbOwnersPalette[1], 
                    0.15,
                    cbOwnersPalette[2],
                    0.22,
                    cbOwnersPalette[3],
                    0.35,
                    cbOwnersPalette[4],
                ]],
                "fill-outline-color": "white",
                "fill-opacity": [
                    "case", ["==", ["get", "pctOwned30"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
             }
        },
        "settlement-major-label", 
        "settlement-subdivision-label", 
        "settlement-minor-label"
    )

    map.addLayer({
                id: "parcels-landuse",
                type: "fill",
                source: "parcels",
                //"source-layer": "parcels_jcia-7q1vz4", 
                paint: {
                    "fill-color": [
                        "match",
                        ["get", "PropClass"],
                        "A", landUsePalette[0],
                        "A,AD", landUsePalette[1],
                        "C", landUsePalette[4],
                        "C,M", landUsePalette[5],
                        "C,R", landUsePalette[5],
                        "E", landUsePalette[7],
                        "I", landUsePalette[6],
                        "R", landUsePalette[2],
                        "M", landUsePalette[3],
                        landUsePalette[8]
                    ],
                    "fill-outline-color": communityScaleGray,
                    "fill-opacity": [
                        "case",
                        ["boolean", ["feature-state", "hover"], false],
                        0.7,
                        0.5
                    ]
                },
                layout: {
                    visibility: "none"
                }
            }, 
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label")

    map.addLayer({ 
            id: "parcels-pctLV",  
            type: "fill",
            source: "parcels",
            //"source-layer": "parcels_jcia-7q1vz4", 
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "pctLandVal"], null], communityScaleGray,
                    ["interpolate", 
                    ["linear"],
                    ["get", "pctLandVal"],
                    0.03,
                    landValuePalette[4], 
                    0.15,
                    landValuePalette[3],
                    0.35,
                    landValuePalette[2],
                    0.65,
                    landValuePalette[1],
                    0.90,
                    landValuePalette[0]]],
                "fill-outline-color": "#545453",
                "fill-opacity": [
                    "case", ["==", ["get", "pctLandVal"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
             }
        },"road-label", 
        "settlement-major-label", 
        "settlement-subdivision-label", 
        "settlement-minor-label"
    )

    map.addLayer(
            {
                id: 'mobileHomes',
                type: 'circle',
                source: 'mobileHomeParks',
                paint: {
                    'circle-radius': {
                        'base': 2,
                        'stops': [
                            [12, 4],
                            [22, 180]
                    ]},
                    'circle-color': "#249bd6"}, 
            layout: {
                visibility: "visible"
            }})

    map.addLayer({ 
            id: "parcels-ownership",  
            type: "fill",
            source: "parcels",
            //"source-layer": "parcels_jcia-7q1vz4", //filter by residential??
            paint: {
                "fill-color": [
                    "match",
                    ["get", "credits"], //update palette
                        "HMST", ownershipPalette[0], 
                        "AG", ownershipPalette[2],
                        "MIL", ownershipPalette[1], 
                        "S42", ownershipPalette[3],
                        "HMST,AG", ownershipPalette[5],
                        "HMST,MIL", ownershipPalette[4],
                        "HMST,AG,MI", ownershipPalette[6],
                        "NONE", ownershipPalette[7],
                        communityScaleGray
                        ],
                "fill-outline-color": "#545453",
                "fill-opacity": [
                    "case", ["==", ["get", "credits"], "NONE"], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
            }},
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label"
    ) 

    map.addLayer({     
            id: "tracts-pctHH",  
            type: "fill",
            source: "tracts",
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "pctChangeHH"], null], communityScaleGray,
                    ["interpolate",
                    ["linear"],
                    ["get", "pctChangeHH"],
                    -0.15,
                    hhChangePalette[0],
                    -0.07, 
                    hhChangePalette[1],
                    -0.01,
                    hhChangePalette[2],
                    0,
                    hhChangePalette[3], 
                    0.1,
                    hhChangePalette[4],
                    0.2,
                    hhChangePalette[5],
                    0.5,
                    hhChangePalette[6]
                ]],
                "fill-outline-color": "white",
                "fill-opacity": [
                    "case", ["==", ["get", "pctChangeHH"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
        }},
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label"
    )

    map.addLayer({ 
            id: "parcels-value", 
            type: "fill",
            source: "parcels",
            //"source-layer": "parcels_jcia-7q1vz4", 
            paint: {
                "fill-color": [
                    "case", ["==", ["get", "acreVal"], null], communityScaleGray,
                    ["interpolate", 
                    ["linear"],
                    ["get", "acreVal"],
                    24000,
                    parcelValuePalette[0], 
                    175000,
                    parcelValuePalette[1],
                    327000,
                    parcelValuePalette[2],
                    575000,
                    parcelValuePalette[3],
                    850000,
                    parcelValuePalette[4]]],
                "fill-outline-color": "#545453",
                "fill-opacity": [
                    "case", ["==", ["get", "acreVal"], null], 0.3,
                    ["case",
                    ["boolean", ["feature-state", "hover"], false],
                    0.95,
                    0.6
            ]]
             },
             layout: {
                visibility: "none"
             }},
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label"
    ) 

    map.addLayer({
            id: "smallCities-layer",
            type: "line",
            source: "cities",
            paint: {
                "line-color": "#ffce0a",
                "line-opacity": 0.8,
                "line-width": 3
                },
            layout: {
                visibility: "visible"
                },
            filter: ["in", "NAME", ...citiesOfInterest]}
        )

    map.addLayer({
            id: "excludedCities-layer",
            type: "fill",
            source: "cities",
            paint: {
                "fill-color": '#d6d6d6',
                "fill-opacity": 1,
                },
            layout: {
                visibility: "visible"
                },
            filter: ["in", "NAME", ...excludedCities]},
            "mobileHomes",
            "settlement-major-label", 
            "settlement-subdivision-label", 
            "settlement-minor-label"
        )
    
    map.addLayer({
            id: "county-layer",
            type: "line",
            source: "counties",
            paint: {
                "line-color": communityScaleGray,
                "line-opacity": 0.8,
                "line-width": 3
                },
            layout: {
                visibility: "visible"
                },
            filter: ["==", "NAME", placeOfInterest]}
        );


    //defaultView
    adjustMapSize();
    });

    window.addEventListener('resize', adjustMapSize);

    const checkboxes = document.querySelectorAll('.layer-toggle');

    checkboxes.forEach((checkbox) => {
    checkbox.addEventListener('change', () => {
        const layerId = checkbox.value;
        const visibility = checkbox.checked ? 'visible' : 'none';
        if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, 'visibility', visibility);
            map.setLayoutProperty("smallCities-layer", 'visibility', 'visible');
            map.setLayoutProperty("mobileHomes", 'visibility', 'visible');
            map.setLayoutProperty("county-layer", 'visibility', 'visible');
            map.setLayoutProperty("road-label", 'visibility', 'visible');
            map.setLayoutProperty("settlement-major-label", 'visibility', 'visible');
            map.setLayoutProperty("settlement-subdivision-label", 'visibility', 'visible');
            map.setLayoutProperty("settlement-minor-label", 'visibility', 'visible');;
        }})})
  
    map.on('click', (e) => {
        const [selectedGeo] = map.queryRenderedFeatures(e.point, {               
            layers: ["tracts-medIncome"]
        });

        if (selectedGeo) {
            const medianIncome = selectedGeo.properties.medIncome;
            const displayIncome = medianIncome === null || medianIncome === undefined ? 'No available data' : `Annual median household income: $${medianIncome.toLocaleString()} (2023 USD)`;

            new mapboxgl.Popup({ closeButton: true }, { clickToClose: true })
            .setLngLat(selectedGeo.geometry.coordinates[0][0])
            .setHTML(`
                <div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${selectedGeo.properties.NAME}</div>
                <div class="mapboxgl-popup-content">${displayIncome}
                </div>
            </div>`)
            .addTo(map);
    }});

    map.on("click", (e)=> {
        const [ selectedGeo ]= map.queryRenderedFeatures(e.point, {
            layers: ["tracts-layer"]
        });

        if (selectedGeo) {
            new mapboxgl.Popup({closeButton: true}, {clickToClose: true})
            .setLngLat(selectedGeo.geometry.coordinates[0][0]) 
            .setHTML(`<div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${selectedGeo.properties.NAME}</div>
            </div>`)
            .addTo(map)
    }});

    map.on('click', (e) => {
        const [selectedGeo] = map.queryRenderedFeatures(e.point, {               
            layers: ["tracts-pctCostBurdenedRenters"]
        });

        if (selectedGeo) {
            const pctRent30 = selectedGeo.properties.pctRent30;
            const roundedPctRent30 = Math.round(pctRent30 * 1000) / 10
            const displayPctRent30 = pctRent30 === null || pctRent30 === undefined ? 'No available data' : `${roundedPctRent30}% of renters in ${selectedGeo.properties.NAME} spend more than 30% of income on housing costs.`;

            new mapboxgl.Popup({ closeButton: true }, { clickToClose: true })
            .setLngLat(selectedGeo.geometry.coordinates[0][0])
            .setHTML(`
                <div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${selectedGeo.properties.NAME}</div>
                <div class="mapboxgl-popup-content">${displayPctRent30}
                </div>
            </div>`)
            .addTo(map);
    }});

    map.on('click', (e) => {
        const [selectedGeo] = map.queryRenderedFeatures(e.point, {               
            layers: ["tracts-pctCostBurdenedOwners"]
        });

        if (selectedGeo) {
            const pctOwned30 = selectedGeo.properties.pctOwned30;
            const roundedPctOwned30 = Math.round(pctOwned30 * 1000) / 10
            const displayPctOwned30 = pctOwned30 === null || pctOwned30 === undefined ? 'No available data' : `${roundedPctOwned30}% of homeowners in ${selectedGeo.properties.NAME} spend more than 30% of income on housing costs.`;

            new mapboxgl.Popup({ closeButton: true }, { clickToClose: true })
            .setLngLat(selectedGeo.geometry.coordinates[0][0])
            .setHTML(`
                <div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${selectedGeo.properties.NAME}</div>
                <div class="mapboxgl-popup-content">${displayPctOwned30}
                </div>
            </div>`)
            .addTo(map);
    }});

    map.on('click', (e) => {
        const [selectedGeo] = map.queryRenderedFeatures(e.point, {               
            layers: ["tracts-pctHH"]
        });

        if (selectedGeo) {
            const pctChangeHH = selectedGeo.properties.pctChangeHH;
            const roundedPctChangeHH = Math.round(pctChangeHH * 1000) / 10
            const displayPctChangeHH = pctChangeHH === null || pctChangeHH === undefined ? 'No available data' : `${selectedGeo.properties.NAME} saw a ${roundedPctChangeHH}% change in the number of households (2013-2023).`;

            new mapboxgl.Popup({ closeButton: true }, { clickToClose: true })
            .setLngLat(selectedGeo.geometry.coordinates[0][0])
            .setHTML(`
                <div class="mapboxgl-popup">
                <div class="mapboxgl-popup-close-button">x</div>
                <div class="mapboxgl-popup-header">${selectedGeo.properties.NAME}</div>
                <div class="mapboxgl-popup-content">${displayPctChangeHH}
                </div>
            </div>`)
            .addTo(map);
    }});


    const dataLayers = [
        'tracts-medIncome', 
        'tracts-pctCostBurdenedRenters', 
        'tracts-pctCostBurdenedOwners',
        'tracts-pctHH',
        'tracts-layer',
        'parcels-landuse',
        'parcels-pctLV',
        'parcels-value',
        'parcels-ownership'
        ];

    const dropdown = document.getElementById('layer-dropdown');

    document.getElementById("opacitySlider").addEventListener("input", function (e) {
        const newOpacity = parseFloat(e.target.value);
        dataLayers.forEach(layerId => {
        map.setPaintProperty(layerId, "fill-opacity", newOpacity);
        });
    });

    dropdown.addEventListener('change', function() {
        const selectedLayer = dropdown.value;
        dataLayers.forEach(layerId => {
            if (layerId !== selectedLayer && map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, 'visibility', 'none');
        }
    });
        
        map.setLayoutProperty(selectedLayer, 'visibility', 'visible');
        map.setLayoutProperty("smallCities-layer", 'visibility', 'visible');
        map.setLayoutProperty("mobileHomes", 'visibility', 'visible');
        map.setLayoutProperty("county-layer", 'visibility', 'visible');
        map.setLayoutProperty("road-label", 'visibility', 'visible');
        map.setLayoutProperty("settlement-major-label", 'visibility', 'visible');
        map.setLayoutProperty("settlement-subdivision-label", 'visibility', 'visible');
        map.setLayoutProperty("settlement-minor-label", 'visibility', 'visible');
    });

    document.getElementById('layer-dropdown').addEventListener('change', function() {
        var legends = document.querySelectorAll('.legend');
        legends.forEach(function(legend) {
        legend.style.display = 'none';
            });

        var selectedLayer = dropdown.value;
        if (selectedLayer === 'tracts-medIncome') {
        document.getElementById('medIncomeLegend').style.display = 'block';
        }      else if (selectedLayer === 'tracts-pctCostBurdenedRenters') {
        document.getElementById('cbRentersLegend').style.display = 'block';
        }   else if (selectedLayer === 'tracts-pctCostBurdenedOwners') {
        document.getElementById('cbOwnersLegend').style.display = 'block';
        }   else if (selectedLayer === 'parcels-pctLV') { 
        document.getElementById('pctLVLegend').style.display = 'block';
        }   else if (selectedLayer === 'parcels-landuse') { 
        document.getElementById('landUseLegend').style.display = 'block';
        }   else if (selectedLayer === 'parcels-ownership') { 
        document.getElementById('ownershipLegend').style.display = 'block';
        }   else if (selectedLayer === 'parcels-value') { 
        document.getElementById('parcelValueLegend').style.display = 'block';
        }   else if (selectedLayer === 'tracts-pctHH') {
        document.getElementById('pctHHLegend').style.display = 'block';
        }});


    document.getElementById("basemapStyle").addEventListener("change", function (e) {
    const newStyle = e.target.value;
    const center = map.getCenter();
    const zoom = map.getZoom();
        map.remove();
        initializeMap(newStyle);
        setTimeout(() => {
            map.setCenter(center);
            map.setZoom(zoom);
        }, 500);
    });

        let hoveredGeoId = null;

        const hoverLayers = [
            { id: 'tracts-medIncome', source: 'tracts'},
            { id: 'tracts-pctCostBurdenedRenters', source: 'tracts'},
            { id: 'tracts-pctCostBurdenedOwners', source: 'tracts' },
            { id: 'tracts-pctHH', source: 'tracts' },
            { id: 'tracts-layer', source: 'tracts' },
            { id: 'parcels-landuse', source: 'parcels'},
            { id: 'parcels-value', source: 'parcels'},
            { id: 'parcels-pctLV', source: 'parcels'},
            { id: 'parcels-ownership', source: 'parcels'}
        ];

        hoverLayers.forEach(({ id, source }) => {
            map.on('mousemove', id, (e) => {
                if (e.features.length > 0) {
                    if (hoveredGeoId !== null) {
                        map.setFeatureState(
                            { source, id: hoveredGeoId },
                            { hover: false }
                        );
                    }
                    hoveredGeoId = e.features[0].id;
                    map.setFeatureState(
                        { source, id: hoveredGeoId },
                        { hover: true }
                    );
                }
            });

            map.on('mouseleave', id, () => {
                if (hoveredGeoId !== null) {
                    map.setFeatureState(
                        { source, id: hoveredGeoId },
                        { hover: false }
                    );
                }
                hoveredGeoId = null;
            });
        })};

        initializeMap();

        </script>
    </body>
</html>
